<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COGNIT | MANDALA</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Courier New', monospace; }
        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 10;
            transition: opacity 1.5s ease;
        }
        h1 { color: white; font-weight: 100; letter-spacing: 12px; font-size: 20px; text-transform: uppercase; }
        button {
            background: transparent; color: #00ff80; border: 1px solid #00ff80;
            padding: 20px 50px; font-family: inherit; font-size: 12px; letter-spacing: 2px;
            cursor: pointer; transition: 0.5s; margin-top: 30px;
        }
        button:hover { background: #00ff80; color: black; box-shadow: 0 0 40px #00ff80; }
        #caption {
            position: absolute; bottom: 30px; width: 100%; text-align: center;
            color: rgba(255,255,255,0.3); font-size: 10px; letter-spacing: 4px;
            pointer-events: none;
        }
    </style>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>

    <div id="overlay">
        <h1>The Shiva Layer</h1>
        <button id="start-btn">INVOKE MANDALA</button>
    </div>
    
    <div id="caption">THE GEOMETRY OF SILENCE</div>

    <script type="module">
        import * as THREE from 'three';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

        let scene, camera, renderer, composer;
        let mandala, core, particles;
        let analyser, dataArray;
        let isRunning = false;

        // --- SETUP ---
        function init() {
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x000000, 0.03);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 15;

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.toneMapping = THREE.ReinhardToneMapping;
            document.body.appendChild(renderer.domElement);

            // POST PROCESSING (The "Dream" Look)
            const renderScene = new RenderPass(scene, camera);
            const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
            bloomPass.strength = 2.5; // High Bloom for "Soul"
            bloomPass.radius = 0.8;
            bloomPass.threshold = 0;

            composer = new EffectComposer(renderer);
            composer.addPass(renderScene);
            composer.addPass(bloomPass);

            createGeometry();
            
            window.addEventListener('resize', onWindowResize, false);
        }

        // --- THE HOLY GEOMETRY ---
        function createGeometry() {
            // 1. The Outer Shell (The Manifold)
            const geoMain = new THREE.IcosahedronGeometry(4, 2); // Detailed sphere
            const matMain = new THREE.MeshStandardMaterial({
                color: 0x000000,
                emissive: 0x00ff80,
                emissiveIntensity: 0.2,
                wireframe: true,
                transparent: true,
                opacity: 0.3
            });
            mandala = new THREE.Mesh(geoMain, matMain);
            scene.add(mandala);

            // 2. The Core (The Source/Atman)
            const geoCore = new THREE.IcosahedronGeometry(2, 4);
            const matCore = new THREE.MeshBasicMaterial({
                color: 0xffffff,
                wireframe: true,
                transparent: true,
                opacity: 0.1
            });
            core = new THREE.Mesh(geoCore, matCore);
            scene.add(core);

            // 3. The Particle Cloud (The Consciousness)
            const particleGeo = new THREE.BufferGeometry();
            const particleCount = 2000;
            const posArray = new Float32Array(particleCount * 3);
            
            for(let i = 0; i < particleCount * 3; i++) {
                posArray[i] = (Math.random() - 0.5) * 25;
            }
            
            particleGeo.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
            const particleMat = new THREE.PointsMaterial({
                size: 0.05,
                color: 0x00ff80,
                transparent: true,
                opacity: 0.8,
                blending: THREE.AdditiveBlending
            });
            
            particles = new THREE.Points(particleGeo, particleMat);
            scene.add(particles);

            // Light
            const ambientLight = new THREE.AmbientLight(0x404040);
            scene.add(ambientLight);
            const pointLight = new THREE.PointLight(0x00ff80, 1, 100);
            pointLight.position.set(10, 10, 10);
            scene.add(pointLight);
        }

        // --- AUDIO INPUT ---
        async function startAudio() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioCtx.createAnalyser();
                const source = audioCtx.createMediaStreamSource(stream);
                source.connect(analyser);
                analyser.fftSize = 512;
                dataArray = new Uint8Array(analyser.frequencyBinCount);
                return true;
            } catch (e) {
                console.error(e);
                return false;
            }
        }

        // --- THE DANCE (Animation Loop) ---
        function animate() {
            requestAnimationFrame(animate);

            if (isRunning && analyser) {
                analyser.getByteFrequencyData(dataArray);

                // Calculate Audio Metrics
                let bass = 0;
                let mid = 0;
                let high = 0;
                
                for(let i = 0; i < dataArray.length; i++) {
                    let val = dataArray[i];
                    if (i < 20) bass += val;
                    else if (i < 100) mid += val;
                    else high += val;
                }
                
                bass /= 20;
                mid /= 80;
                high /= (dataArray.length - 100);

                // 1. BREATHING: The Mandala expands with Bass
                const scale = 1 + (bass / 255) * 0.8;
                mandala.scale.set(scale, scale, scale);
                mandala.rotation.y += 0.002 + (mid / 5000);
                mandala.rotation.z += 0.001;

                // 2. INTENSITY: The Core glows with Mids
                core.scale.set(0.5 + (mid/255), 0.5 + (mid/255), 0.5 + (mid/255));
                core.rotation.x -= 0.01;
                mandala.material.emissiveIntensity = (bass / 255) * 2;

                // 3. CHAOS: Particles swirl with Highs
                particles.rotation.y += 0.001 + (high / 1000);
                
                // Camera subtle movement (The "Floating" feeling)
                camera.position.x = Math.sin(Date.now() * 0.0005) * 2;
                camera.position.y = Math.cos(Date.now() * 0.0005) * 2;
                camera.lookAt(0,0,0);
            }

            composer.render();
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        }

        // --- INITIALIZATION ---
        init();
        document.getElementById('start-btn').addEventListener('click', async () => {
            const ready = await startAudio();
            if (ready) {
                isRunning = true;
                const overlay = document.getElementById('overlay');
                overlay.style.opacity = 0;
                setTimeout(() => overlay.style.display = 'none', 1500);
                animate();
            }
        });
    </script>
</body>
</html>
